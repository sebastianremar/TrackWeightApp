name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: back
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: back/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Security audit
        run: npm audit --omit=dev || true

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user/SaraPesoApp
            PREV_SHA=$(git rev-parse HEAD)
            echo "$PREV_SHA" > /tmp/deploy-prev-sha
            git fetch origin main
            git reset --hard origin/main
            cd front
            npm ci
            npm run build -- --outDir dist-tmp
            rm -rf dist
            mv dist-tmp dist
            cd ../back
            npm ci --omit=dev
            mkdir -p logs
            pm2 restart ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

      - name: Health check
        id: healthcheck
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sleep 5
            for i in 1 2 3 4 5; do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000/health" || true)
              if [ "$STATUS" = "200" ]; then
                echo "Health check passed"
                exit 0
              fi
              echo "Attempt $i: got status $STATUS, retrying..."
              sleep 3
            done
            echo "Health check failed after 5 attempts"
            exit 1

      - name: Rollback on failure
        if: failure() && steps.healthcheck.outcome == 'failure'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ec2-user/SaraPesoApp
            PREV_SHA=$(cat /tmp/deploy-prev-sha 2>/dev/null)
            if [ -z "$PREV_SHA" ]; then
              echo "No previous SHA found, cannot rollback"
              exit 1
            fi
            echo "Rolling back to $PREV_SHA"
            git reset --hard "$PREV_SHA"
            cd front
            npm ci
            npm run build -- --outDir dist-tmp
            rm -rf dist
            mv dist-tmp dist
            cd ../back
            npm ci --omit=dev
            pm2 restart ecosystem.config.js --env production
            echo "Rollback complete"
